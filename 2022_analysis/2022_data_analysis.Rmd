---
title: "Gun cases per day"
author: "Micah Clark Moody"
date: "3/2/2022"
output: html_document
---

# Load required packages
```{r setup}
library(tidyverse)
library(lubridate)
library(knitr)
```

# Import and clean data
? make import reproducible (get rid of desktop path) (choice based on identifiable data...)
X in .csv remove ASA, atty, and columns after "notes"
- ^ CHANGE, use original .csv and deselect
- vector charge_type to be in order
- check if I ever use intake data

obs_data notes

sa data notes
initiation

- Often, in a case, defendants are charged with multiple things. I'm limiting analysis to the most serious charge, represented by binary `PRIMARY_CHARGE_FLAG` variable.

```{r, setup} 
# dataset 1
# importing data from my observations (obs_data)
obs_data <- read.csv("~/Desktop/r/bond_court/data/data_cleaned.csv") %>%
  
  # removing identifiable information
  select(-c(judge))

# coercing numeric variables
obs_data$can_post <- as.numeric(obs_data$can_post) 
obs_data$bond_amount <- as.numeric(obs_data$bond_amount)

# creating dummy variable for excessive bond
obs_data <- obs_data %>%
  filter(bond_type == "D") %>%
  drop_na() %>%
  mutate("bond_excess" = ifelse(((can_post * 10) < bond_amount), 1, 0)) %>%
  full_join(obs_data)


# dataset 2
# importing data from the Cook County State's Attorney's Office (sa) case initiaion
sa_init <- read.csv("~/Desktop/r/bond_court/data/2022-07-03 CCSAO Data/Initiation.csv") %>%
  filter(PRIMARY_CHARGE_FLAG == "true")

# converting "RECEIVED_DATE" into a date variable
sa_init$RECEIVED_DATE <- mdy_hms(sa_init$RECEIVED_DATE)

# creating sa_init dataset binned by month
sa_init_month <- sa_init

sa_init_month$RECEIVED_DATE <- floor_date(sa_init_month$RECEIVED_DATE, "month")


# dataset 3
# importing data from the Cook County State's Attorney's Office (sa) case intake
sa_intake <- read.csv("~/Desktop/r/bond_court/data/2022-07-03 CCSAO Data/Intake.csv")

# converting "RECEIVED_DATE" into a date variable
sa_intake$RECEIVED_DATE <- mdy(sa_intake$RECEIVED_DATE)
```

```{r}
# IMPORT when using n = 100 obs for coding quickly
sa_init_full <- read.csv("~/Desktop/r/bond_court/data/2022-07-03 CCSAO Data/Initiation.csv")

# small sample for writing code quickly
sa_init <- sa_init_full %>%
  slice_sample(n = 500) %>%
  filter(PRIMARY_CHARGE_FLAG == "true")


# IMPORT when using n = 100 obs for coding quickly
sa_intake_full <- read.csv("~/Desktop/r/bond_court/data/2022-07-03 CCSAO Data/Intake.csv")

# small sample for writing code quickly
sa_intake <- sa_intake_full %>%
  slice_sample(n = 100)
```

# Case and bond type over time
Question: In visual look at the n = 100 sample bond was reduced in ANY cases except one that went from no to D

X bin gun-related arrests into one category (only one relevant category)

# Drug and gun cases over time
```{r}
sa_init_type <- sa_init %>%
  filter(OFFENSE_CATEGORY == c("Narcotics", "UUW - Unlawful Use of Weapon")) %>%
  select(RECEIVED_DATE, OFFENSE_CATEGORY)

sa_init_type$RECEIVED_DATE <- floor_date(sa_init_type$RECEIVED_DATE, "month")
  
sa_init_type %>%
  group_by(RECEIVED_DATE, OFFENSE_CATEGORY) %>%
  summarize(n()) %>%
  ggplot(
    mapping = aes(
      x = RECEIVED_DATE,
      y = `n()`,
      color = OFFENSE_CATEGORY
    )) + 
  geom_point() +
  geom_smooth()
```
# proportion of class 3, 2, and x UUW cases since 2011
- IDEA: as % of gun cases
flag and explore: UNLAWFUL POSSESSION OF A FIREARM BY A STREET GANG MEMBER
flag how many exist: AGG UUW/VEH/FIR LOADED/NO FOID

```{r}
gun_cases <- sa_init_month %>%
  filter(OFFENSE_CATEGORY == "UUW - Unlawful Use of Weapon")

# list of gun possession charges 
# method: top 20 most common highest charge for gun case OFFENSE_CATEGORY limited to gun possession as underlying conduct
gun_poss <- c(
  "AGGRAVATED UNLAWFUL USE OF WEAPON", 
  "UNLAWFUL USE OR POSSESSION OF A WEAPON BY A FELON",
  "AGG UUW/LOADED/NO FCCA/FOID",
  "ARMED HABITUAL CRIMINAL",
  "UNLAWFUL USE OF A WEAPON",
  "UNLAWFUL POSSESSION OF A FIREARM BY A STREET GANG MEMBER",
  "POSS FIREARM FOID REVOKED",
  "AGG UUW/UNLOADED/NO FCCA",
  "POSSESSION OF STOLEN FIREARM",
  "AGG UUW/VEH/FIR LOADED/NO FOID",
  "FIREARM/FOID INVALID/NOT ELIG")
uuw <- c("AGGRAVATED UNLAWFUL USE OF WEAPON", 
  "AGG UUW/LOADED/NO FCCA/FOID",
  "UNLAWFUL USE OF A WEAPON",
  "POSS FIREARM FOID REVOKED",
  "AGG UUW/UNLOADED/NO FCCA",
  "AGG UUW/VEH/FIR LOADED/NO FOID",
  "FIREARM/FOID INVALID/NOT ELIG")
uuw_f <- c("UNLAWFUL USE OR POSSESSION OF A WEAPON BY A FELON")
ahc <- c("ARMED HABITUAL CRIMINAL")

# total cases by charge
gun_cases %>%
  group_by(RECEIVED_DATE, CHARGE_OFFENSE_TITLE) %>%
  # filter(CHARGE_OFFENSE_TITLE %in% gun_poss) %>%
  filter(`CHARGE_OFFENSE_TITLE` %in% c(
  "AGGRAVATED UNLAWFUL USE OF WEAPON", 
  "AGG UUW/LOADED/NO FCCA/FOID",
  "UNLAWFUL USE OF A WEAPON",
  "POSS FIREARM FOID REVOKED",
  "AGG UUW/UNLOADED/NO FCCA",
  "AGG UUW/VEH/FIR LOADED/NO FOID",
  "FIREARM/FOID INVALID/NOT ELIG",
  "UNLAWFUL USE OR POSSESSION OF A WEAPON BY A FELON",
  "ARMED HABITUAL CRIMINAL")) %>%
  summarise(n()) %>%
  ggplot(mapping = aes(
    x = RECEIVED_DATE,
    y = `n()`,
    color = CHARGE_OFFENSE_TITLE
  )) +
  geom_point() +
  geom_smooth() 
```

# Drug case bond over time
I believe NULL results for bond indicate the case was dismissed Nolle Pros

In the documentation it is defined as "Null: No record of bond found." 

The record of Nolles is in the Disposition data. Match dispositions to CASE_ID in sa_init so see if they preserve cases Nolle-ed at initial bond hearing and, if they do, see if initiation$BOND_TYPE_CURRENT = NULL is a defacto Nolle Pros variable

Testing this real quick by getting rid of narcotics filter and seeing if it goes down. Okay, nope, NULL doesn't seem to be Nolle because red is at almost 50% there. Okay, lets see, initial. Nope, initial and current are the same.

```{r}
sa_init_month %>%
  filter(OFFENSE_CATEGORY == "Narcotics") %>%
  
  # summing cases per month ("n")
  add_count(RECEIVED_DATE) %>%
  
  # summing cases by bond condition ("nn")
  count(RECEIVED_DATE, BOND_TYPE_INITIAL, `n`) %>%
  
  # creating percentage of cases each month ("type_mean")
  mutate(type_mean = nn / n) %>%
  ggplot(
    mapping = aes(
      x = RECEIVED_DATE,
      y = type_mean,
      color = BOND_TYPE_INITIAL
    )
  ) +
  geom_point() +
  geom_smooth()
```

# Gun case bond over time
```{r}
bond_types <- c("I Bond", "D Bond", "C Bond", "No Bond")

sa_init_month %>%
  filter(OFFENSE_CATEGORY == "UUW - Unlawful Use of Weapon", 
         
         # taking out NULL bond type (need to figure out what's going on there)
         BOND_TYPE_INITIAL %in% bond_types) %>%
  
  # summing cases per month ("n")
  add_count(RECEIVED_DATE) %>%
  
  # summing cases by bond condition ("nn")
  count(RECEIVED_DATE, BOND_TYPE_INITIAL, `n`) %>%
  
  # creating percentage of cases each month ("type_mean")
  mutate(type_mean = nn / n) %>%
  ggplot(
    mapping = aes(
      x = RECEIVED_DATE,
      y = type_mean,
      color = BOND_TYPE_INITIAL
    )
  ) +
  geom_point() +
  geom_smooth()
```

# ASA Data Drug Cases
```{r}
initiation_test %>%
  filter(OFFENSE_CATEGORY == "narcotics")
  
  
# BOND_REDUCED, 1 = yes, 0 = no
initiation_test %>%
  filter(BOND_TYPE_INITIAL == "D") %>%
  
  # not quite right doesn't account for D to I or D to no
  mutate("BOND_REDUCED" = ifelse((BOND_AMOUNT_INITIAL > BOND_AMOUNT_CURRET), 1, 0))

```

Drug cases I observed
```{r}
data %>%
  filter(
    charge_type == "4 - drug sales (manufacture/delivery, PCS with intent)" 
    | charge_type == "3 - drug possession (PCS)") %>%
  group_by(nole) %>%
  summarize(n()) %>%
  mutate("percent" = ((`n()`/(92+16))*100)) %>%
  kable()

data %>%
  filter(
    charge_type == "4 - drug sales (manufacture/delivery, PCS with intent)" 
    | charge_type == "3 - drug possession (PCS)") %>%
  group_by(bond_type) %>%
  summarize(n()) %>%
  mutate("percent" = (`n()`/(32+56)*100)) %>%
  kable()

bond_excess %>%
  filter(
    charge_type == "4 - drug sales (manufacture/delivery, PCS with intent)" 
    | charge_type == "3 - drug possession (PCS)") %>%
  group_by(bond_excess) %>%
  summarize(n()) %>%
  mutate("percent" = (`n()`/(25)*100)) %>%
  kable()


```

# Affordable bond
Bail as a release condition
Intro
In the cases I observed, bail was set at an affordable level % of the time, with a median affordable bail of #
```{r}

# Cases where a D bond was set
data %>%
  group_by(bond_type) %>%
  summarise(n()) %>%
  mutate("percent" = ((`n()`/(439-59))*100)) %>%
  kable()

# Affordability of D bond
bond_excess %>%
  group_by(bond_excess) %>%
  summarise(n()) %>%
  mutate("percent" = ((`n()`/(67+105))*100)) %>%
  kable()

# in cases with violations
bond_excess %>%
  filter(violations == "VOBB" | violations == "IDOC Hold" | violations == "VOP" ) %>%
  group_by(bond_excess) %>%
  summarise(n()) %>%
  mutate("percent" = ((`n()`/(32))*100)) %>%
  kable()

# Median D-Bond
test <- bond_excess %>%
  filter(bond_excess == 0)

median(test$bond_amount)

# excessive bond proportion
mutate(bond_excess$req_post)


post <- bond_excess %>%
  select(bond_amount, can_post) %>%
  mutate(
    req_post = bond_amount / 10
  )


```

Bail as a release condition
4 - AUUW
"This presumption is standard for first time gun possession cases, where bail was set at an affordable level in % of the cases I observed" (07-02-2022)
```{r}

# 4-AUUW cases bond affordable
# NOTE: bond_excess only has 172 obs meaning `235-172` cases where a D-bond was set I didn't record can_post and/or bond_amount
# NOTE: bond_excess data set should be `data` after cleaning the intro section

bond_excess %>%
  filter(class_1 == "4", charge_1 == "UUW") %>%
  group_by(bond_excess) %>%
  summarise(n()) %>%
  mutate("percent" = (`n()`/93)*100) %>%
  kable()

# 4-AUUW cases I-bond

data %>%
  filter(class_1 == "4", charge_1 == "UUW") %>%
  group_by(bond_type) %>%
  summarise(n()) %>%
  mutate("percent" = (`n()`/93)*100) %>%
  kable()
  
```

Bail for jailing
Other violations
```{r}
data %>%
  filter(bond_amount >= 100000) %>%
  group_by(violations) %>%
  summarise(n()) %>%
  mutate("percent" = (`n()`/(18+3+2+11+1))*100) %>%
  kable()

data %>%
  #filter(bond_amount >= 100000) %>%
  group_by(violations) %>%
  summarise(n()) %>%
  mutate("percent" = (`n()`/(297+21+47+21+1+43+9))*100) %>%
  kable()
```

# Drug cases over time
```{r}
offense_category <- unique(intake$OFFENSE_CATEGORY)

narc_initiation <- initiation %>%
  filter(OFFENSE_CATEGORY == "Narcotics")

narc_initiation %>%
  group_by(RECEIVED_DATE) %>%
  summarize(n()) %>%
  ggplot(mapping = aes(
    x = RECEIVED_DATE,
    y = `n()`
  )) +
    geom_point()

```

# Bond initial and current
```{r}

```

# Breaking down data by judge
## Bond type for each judge
Question: What is the percentage use of each bond type by judge?

```{r, bond_type_by_judge}
judge_bond <- data %>%
  filter(judge != "?", bond_type != "") %>%
  group_by(bond_type, judge) %>%
  summarize(n())

judge <- data %>%
  filter(judge != "?", bond_type != "") %>%
  group_by(judge) %>%
  summarise(n()) %>%
  rename("total_cases" = "n()")

judge_bond <- full_join(judge_bond, judge) %>%
  mutate("percent" = `n()` / `total_cases`)

ggplot(judge_bond, mapping = aes(
  x = bond_type,
  y = `percent`
)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(facets = "judge") + 
  labs(
    title = "Percentage of Bond Type by Judge",
    x = "Bond Type",
    y = "Percentage of Total Bonds"
  )

kable(judge)
```

## Excessive bond for each judge
Question: What percentage of cases where judges assign a D-bond is that bond in excess of what defendants can post?

```{r, excessive_bond_by_judge}
bond_excess %>%
  filter(judge != "?", !is.na(bond_excess)) %>%
  ggplot(mapping = aes(
    x = judge,
    y = bond_excess
)) +
  geom_bar(stat = "summary")
```

Bond reductions by case
```{r}
test <- initiation %>%
  mutate()
  
```

# Breaking down EM information
***Limitation:*** Judges do not consistently state or explain EM conditions. For example, "5000 D with a monitor" would be a common ruling but it is not clear the conditions of monitoring. For this reason, I don't distinguish between types of EM. I am also concerned there is an under count of cases with EM so I will not compare EM to the total number of cases, instead limiting my analysis to the cases that are positively identified as having judge-assigned EM.

## Cases with EM information
Question: what cases have EM as a condition? Were these charges legally eligible for pretrial incarceration?

```{r, EM}
# charges that are ELIGIBLE for pretrial incarceration
# importing .csv summarizing probation-eligible charges. See prob_eligible$link for citations
prob_eligible <- read.csv("~/Desktop/r/bond_court/prob_eligible.csv")

# number of EM conditions by charge category
data %>%
  filter(condition == "EM") %>%
  group_by(charge_type) %>%
  ggplot(mapping = aes(
    x = charge_type
  )) +
  geom_bar() +
  scale_x_discrete(guide = guide_axis(angle = 45))

# table of charges
EM <- data %>%
  filter(condition == "EM", class_1 != "Unknown") %>%
  group_by(class_1, charge_1) %>%
  select(class_1, charge_1) %>%
  summarise(total = n()) %>%
  full_join(prob_eligible) %>%
  select(-c("law","link")) %>%
  drop_na()

kable(EM) 

# total incarceration elegible versus not eligible
EM %>%
  ggplot(mapping = aes(
    x = probation_eligible,
    y = total
  )) +
  geom_col()

```

# VOBB cases and charge severity
```{r}
data_cleaned

VOBB <- data_cleaned %>%
  filter(violations == "VOBB") %>%
  group_by(charge_1)

4/38
```
